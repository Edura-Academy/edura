// Edura - Kurs Takip Sistemi Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MUDUR
  OGRETMEN
  SEKRETER
  OGRENCI
}

enum MessageStatus {
  OKUNMADI
  OKUNDU
}

enum NotificationType {
  BILDIRIM
  ONAY_TALEBI
  SISTEM
}

enum ExamType {
  DENEME
  SINAV
  QUIZ
}

// Kullanıcılar tablosu - Tüm roller için merkezi tablo
model User {
  id                String   @id @default(uuid())
  email             String   @unique
  password          String
  ad                String
  soyad             String
  telefon           String?
  dogumTarihi       DateTime?
  role              Role
  aktif             Boolean  @default(true)
  olusturanId       String?  // Kim tarafından oluşturuldu
  olusturan         User?    @relation("UserOlusturan", fields: [olusturanId], references: [id])
  olusturulanlar    User[]   @relation("UserOlusturan")
  
  // Öğrenci özellikleri
  sinifId           String?
  sinif             Sinif?   @relation(fields: [sinifId], references: [id])
  ogrenciNo         String?  @unique
  
  // Öğretmen özellikleri
  brans             String?
  
  // İlişkiler
  gonderdigiMesajlar    Message[] @relation("GonderenMesajlar")
  aldigiMesajlar        Message[] @relation("AlanMesajlar")
  bildirimleri          Notification[]
  sinavSonuclari        ExamResult[]
  dersKayitlari         CourseEnrollment[]
  ogretmenDersleri      Course[] @relation("OgretmenDersler")
  devamsizliklar        Devamsizlik[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([email])
  @@index([role])
  @@index([sinifId])
}

// Sınıflar
model Sinif {
  id          String   @id @default(uuid())
  ad          String   @unique // 8-A, 9-B, etc.
  seviye      Int      // 8, 9, 10, etc.
  aktif       Boolean  @default(true)
  
  ogrenciler  User[]
  dersler     Course[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Dersler/Kurslar
model Course {
  id              String   @id @default(uuid())
  ad              String
  aciklama        String?
  sinifId         String
  sinif           Sinif    @relation(fields: [sinifId], references: [id])
  ogretmenId      String
  ogretmen        User     @relation("OgretmenDersler", fields: [ogretmenId], references: [id])
  gun             String   // Pazartesi, Salı, etc.
  baslangicSaati  String
  bitisSaati      String
  aktif           Boolean  @default(true)
  
  kayitlar        CourseEnrollment[]
  sinavlar        Exam[]
  devamsizliklar  Devamsizlik[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sinifId])
  @@index([ogretmenId])
}

// Ders kayıtları (Öğrenci-Ders ilişkisi)
model CourseEnrollment {
  id          String   @id @default(uuid())
  ogrenciId   String
  ogrenci     User     @relation(fields: [ogrenciId], references: [id])
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id])
  kayitTarihi DateTime @default(now())
  aktif       Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([ogrenciId, courseId])
  @@index([ogrenciId])
  @@index([courseId])
}

// Sınavlar
model Exam {
  id          String     @id @default(uuid())
  ad          String
  tip         ExamType
  courseId    String
  course      Course     @relation(fields: [courseId], references: [id])
  tarih       DateTime
  sure        Int?       // dakika
  toplamPuan  Int
  aciklama    String?
  
  sonuclar    ExamResult[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([courseId])
  @@index([tarih])
}

// Sınav sonuçları
model ExamResult {
  id          String   @id @default(uuid())
  examId      String
  exam        Exam     @relation(fields: [examId], references: [id])
  ogrenciId   String
  ogrenci     User     @relation(fields: [ogrenciId], references: [id])
  puan        Float
  dogru       Int?
  yanlis      Int?
  bos         Int?
  yuzde       Float?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([examId, ogrenciId])
  @@index([ogrenciId])
  @@index([examId])
}

// Devamsızlık kayıtları
model Devamsizlik {
  id          String   @id @default(uuid())
  ogrenciId   String
  ogrenci     User     @relation(fields: [ogrenciId], references: [id])
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id])
  tarih       DateTime
  aciklama    String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ogrenciId])
  @@index([courseId])
  @@index([tarih])
}

// Mesajlaşma sistemi
model Message {
  id          String        @id @default(uuid())
  gonderenId  String
  gonderen    User          @relation("GonderenMesajlar", fields: [gonderenId], references: [id])
  alanId      String
  alan        User          @relation("AlanMesajlar", fields: [alanId], references: [id])
  baslik      String
  icerik      String
  durum       MessageStatus @default(OKUNMADI)
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([gonderenId])
  @@index([alanId])
  @@index([durum])
  @@index([createdAt])
}

// Bildirimler
model Notification {
  id          String           @id @default(uuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id])
  tip         NotificationType
  baslik      String
  mesaj       String
  okundu      Boolean          @default(false)
  onayTalebi  Boolean          @default(false)
  onayDurumu  String?          // BEKLEMEDE, ONAYLANDI, REDDEDILDI
  ilgiliId    String?          // Onay için ilgili kayıt ID'si
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([userId])
  @@index([okundu])
  @@index([createdAt])
}
