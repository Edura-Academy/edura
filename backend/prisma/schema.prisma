// Edura - Kurs Takip Sistemi Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  relationMode = "prisma"
}

enum Role {
  admin
  mudur
  ogretmen
  sekreter
  ogrenci
}

enum SinifTipi {
  ORTAOKUL
  LISE
}

enum MessageStatus {
  OKUNMADI
  OKUNDU
}

enum NotificationType {
  BILDIRIM
  ONAY_TALEBI
  SISTEM
}

enum ExamType {
  DENEME
  SINAV
  QUIZ
}

enum OdevDurum {
  BEKLEMEDE
  TESLIM_EDILDI
  DEGERLENDIRILDI
}

enum YoklamaDurum {
  KATILDI
  KATILMADI
  GEC_KALDI
  IZINLI
}

// Kurslar/Şubeler
model Kurs {
  id          String   @id @default(uuid())
  ad          String   @unique // Edura Merkez, Edura Çankaya, etc.
  adres       String
  telefon     String
  aktif       Boolean  @default(true)
  
  siniflar    Sinif[]
  users       User[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Kullanıcılar tablosu - Tüm roller için merkezi tablo
model User {
  id                String   @id @default(uuid())
  email             String   @unique
  password          String
  ad                String
  soyad             String
  telefon           String?
  dogumTarihi       DateTime?
  role              Role
  aktif             Boolean  @default(true)
  olusturanId       String?  // Kim tarafından oluşturuldu
  olusturan         User?    @relation("UserOlusturan", fields: [olusturanId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  olusturulanlar    User[]   @relation("UserOlusturan")
  
  // Kurs ilişkisi
  kursId            String?
  kurs              Kurs?    @relation(fields: [kursId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  // Öğrenci özellikleri
  sinifId           String?
  sinif             Sinif?   @relation(fields: [sinifId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ogrenciNo         String?  @unique
  
  // Veli bilgileri (öğrenci için)
  veliAd            String?
  veliSoyad         String?
  veliTelefon       String?
  veliEmail         String?
  
  // Öğretmen özellikleri
  brans             String?
  
  // Push Notification
  fcmToken          String?   // Firebase Cloud Messaging token
  
  // İlişkiler
  gonderdigiMesajlar    Message[] @relation("GonderenMesajlar")
  aldigiMesajlar        Message[] @relation("AlanMesajlar")
  konusmaUyelikleri     ConversationMember[]
  bildirimleri          Notification[]
  sinavSonuclari        ExamResult[]
  dersKayitlari         CourseEnrollment[]
  ogretmenDersleri      Course[] @relation("OgretmenDersler")
  devamsizliklar        Devamsizlik[]
  yoklamalari           Yoklama[]
  ogretmenOdevleri      Odev[] @relation("OgretmenOdevler")
  odevTeslimleri        OdevTeslim[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([email])
  @@index([role])
  @@index([sinifId])
  @@index([kursId])
  @@index([olusturanId])
}

// Sınıflar
model Sinif {
  id          String     @id @default(uuid())
  ad          String     // 8-A, 9-B, etc.
  seviye      Int        // 5, 6, 7, 8, 9, 10, 11, 12
  tip         SinifTipi  // ORTAOKUL, LISE
  kursId      String
  kurs        Kurs       @relation(fields: [kursId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  aktif       Boolean    @default(true)
  
  ogrenciler  User[]
  dersler     Course[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([ad, kursId]) // Aynı kursta aynı isimli sınıf olamaz
  @@index([kursId])
  @@index([seviye])
}

// Dersler/Kurslar
model Course {
  id              String   @id @default(uuid())
  ad              String
  aciklama        String?
  sinifId         String
  sinif           Sinif    @relation(fields: [sinifId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ogretmenId      String
  ogretmen        User     @relation("OgretmenDersler", fields: [ogretmenId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  gun             String   // Pazartesi, Salı, etc.
  baslangicSaati  String
  bitisSaati      String
  aktif           Boolean  @default(true)
  
  kayitlar        CourseEnrollment[]
  sinavlar        Exam[]
  devamsizliklar  Devamsizlik[]
  yoklamalar      Yoklama[]
  odevler         Odev[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sinifId])
  @@index([ogretmenId])
}

// Ders kayıtları (Öğrenci-Ders ilişkisi)
model CourseEnrollment {
  id          String   @id @default(uuid())
  ogrenciId   String
  ogrenci     User     @relation(fields: [ogrenciId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  kayitTarihi DateTime @default(now())
  aktif       Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([ogrenciId, courseId])
  @@index([ogrenciId])
  @@index([courseId])
}

// Sınavlar
model Exam {
  id          String     @id @default(uuid())
  ad          String
  tip         ExamType
  courseId    String
  course      Course     @relation(fields: [courseId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tarih       DateTime
  sure        Int?       // dakika
  toplamPuan  Int
  aciklama    String?
  
  sonuclar    ExamResult[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([courseId])
  @@index([tarih])
}

// Sınav sonuçları
model ExamResult {
  id          String   @id @default(uuid())
  examId      String
  exam        Exam     @relation(fields: [examId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ogrenciId   String
  ogrenci     User     @relation(fields: [ogrenciId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  puan        Float
  dogru       Int?
  yanlis      Int?
  bos         Int?
  yuzde       Float?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([examId, ogrenciId])
  @@index([ogrenciId])
  @@index([examId])
}

// Devamsızlık kayıtları
model Devamsizlik {
  id          String   @id @default(uuid())
  ogrenciId   String
  ogrenci     User     @relation(fields: [ogrenciId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tarih       DateTime
  aciklama    String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ogrenciId])
  @@index([courseId])
  @@index([tarih])
}

// Mesajlaşma sistemi - Konuşmalar (1-1 ve Grup)
enum ConversationType {
  OZEL       // 1-1 özel mesaj
  SINIF      // Sınıf grubu
  OGRETMEN   // Öğretmen grubu (aynı kursta)
  PERSONEL   // Personel grubu (müdür, sekreter, öğretmen)
  OZEL_GRUP  // Özel oluşturulan grup
}

model Conversation {
  id            String           @id @default(uuid())
  tip           ConversationType
  ad            String?          // Grup adı (1-1 için null)
  aciklama      String?
  resimUrl      String?
  olusturanId   String?
  
  // Sınıf grubu için
  sinifId       String?
  
  uyeler        ConversationMember[]
  mesajlar      Message[]
  
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([tip])
  @@index([sinifId])
  @@index([createdAt])
}

model ConversationMember {
  id              String       @id @default(uuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  rolAd           String?      // Grup içi rol: admin, uye
  seslesiz        Boolean      @default(false) // Bildirimleri kapat
  sabitle         Boolean      @default(false) // Konuşmayı sabitle
  sonGorulenMesajId String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
}

model Message {
  id              String        @id @default(uuid())
  conversationId  String
  conversation    Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  gonderenId      String
  gonderen        User          @relation("GonderenMesajlar", fields: [gonderenId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  // Eski 1-1 mesaj sistemi için geriye uyumluluk
  alanId          String?
  alan            User?         @relation("AlanMesajlar", fields: [alanId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  icerik          String        @db.Text
  baslik          String?
  durum           MessageStatus @default(OKUNMADI)
  
  // Ek özellikler
  dosyaUrl        String?
  dosyaTip        String?       // image, document, audio
  yanitladigiMesajId String?    // Yanıt verilen mesaj
  duzenlendi      Boolean       @default(false)
  silindi         Boolean       @default(false)
  
  okuyanlar       MessageRead[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([conversationId])
  @@index([gonderenId])
  @@index([alanId])
  @@index([durum])
  @@index([createdAt])
}

// Mesaj okunma durumu (grup mesajları için)
model MessageRead {
  id          String   @id @default(uuid())
  mesajId     String
  mesaj       Message  @relation(fields: [mesajId], references: [id], onDelete: Cascade)
  userId      String
  okunmaTarihi DateTime @default(now())
  
  @@unique([mesajId, userId])
  @@index([mesajId])
  @@index([userId])
}

// Bildirimler
model Notification {
  id          String           @id @default(uuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tip         NotificationType
  baslik      String
  mesaj       String
  okundu      Boolean          @default(false)
  onayTalebi  Boolean          @default(false)
  onayDurumu  String?          // BEKLEMEDE, ONAYLANDI, REDDEDILDI
  ilgiliId    String?          // Onay için ilgili kayıt ID'si
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([userId])
  @@index([okundu])
  @@index([createdAt])
}

// Yoklama kayıtları - Öğretmen tarafından alınır
model Yoklama {
  id          String       @id @default(uuid())
  ogrenciId   String
  ogrenci     User         @relation(fields: [ogrenciId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  courseId    String
  course      Course       @relation(fields: [courseId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tarih       DateTime     @default(now())
  durum       YoklamaDurum
  aciklama    String?
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([ogrenciId, courseId, tarih])
  @@index([ogrenciId])
  @@index([courseId])
  @@index([tarih])
}

// Ödevler - Öğretmen tarafından verilir
model Odev {
  id              String    @id @default(uuid())
  baslik          String
  aciklama        String?
  courseId        String
  course          Course    @relation(fields: [courseId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ogretmenId      String
  ogretmen        User      @relation("OgretmenOdevler", fields: [ogretmenId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  sonTeslimTarihi DateTime
  maxPuan         Int       @default(100)
  aktif           Boolean   @default(true)
  
  teslimler       OdevTeslim[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([courseId])
  @@index([ogretmenId])
  @@index([sonTeslimTarihi])
}

// Ödev teslimleri - Öğrenci tarafından teslim edilir, Öğretmen tarafından değerlendirilir
model OdevTeslim {
  id          String    @id @default(uuid())
  odevId      String
  odev        Odev      @relation(fields: [odevId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ogrenciId   String
  ogrenci     User      @relation(fields: [ogrenciId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  teslimTarihi DateTime @default(now())
  dosyaUrl    String?
  aciklama    String?
  durum       OdevDurum @default(BEKLEMEDE)
  puan        Int?
  ogretmenYorumu String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([odevId, ogrenciId])
  @@index([odevId])
  @@index([ogrenciId])
  @@index([durum])
}
