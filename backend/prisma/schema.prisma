// Edura - Kurs Takip Sistemi
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

// Kullanıcı Rolleri
enum UserRole {
  ADMIN
  MUDUR
  OGRETMEN
  OGRENCI
}

// Okul Türü
enum SchoolType {
  ORTAOKUL
  LISE
}

// Ana Kullanıcı Tablosu
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(OGRENCI)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  student Student?
  teacher Teacher?

  @@map("users")
}

// Öğrenci Detayları
model Student {
  id          String     @id @default(uuid())
  userId      String     @unique
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  schoolType  SchoolType
  grade       Int        // Sınıf (5-12)
  parentName  String?
  parentPhone String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  enrollments Enrollment[]
  progress    Progress[]
  quizResults QuizResult[]
  certificates Certificate[]

  @@map("students")
}

// Öğretmen Detayları
model Teacher {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isCoach   Boolean  @default(false) // Eğitim koçu mu?
  subjects  String?  // Branşlar (JSON olarak saklanabilir)
  bio       String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  courses Course[]

  @@map("teachers")
}

// Kurslar
model Course {
  id          String   @id @default(uuid())
  title       String
  description String?  @db.Text
  thumbnail   String?
  teacherId   String
  teacher     Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  lessons     Lesson[]
  enrollments Enrollment[]
  certificates Certificate[]

  @@map("courses")
}

// Dersler
model Lesson {
  id          String   @id @default(uuid())
  title       String
  description String?  @db.Text
  videoUrl    String?
  duration    Int?     // Dakika cinsinden
  order       Int
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  progress Progress[]
  quizzes  Quiz[]

  @@map("lessons")
}

// Kayıtlar (Öğrenci-Kurs ilişkisi)
model Enrollment {
  id         String   @id @default(uuid())
  studentId  String
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  courseId   String
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  enrolledAt DateTime @default(now())

  @@unique([studentId, courseId])
  @@map("enrollments")
}

// İlerleme Takibi
model Progress {
  id          String    @id @default(uuid())
  studentId   String
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lessonId    String
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  completed   Boolean   @default(false)
  completedAt DateTime?
  watchedTime Int       @default(0) // Saniye cinsinden izlenen süre
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([studentId, lessonId])
  @@map("progress")
}

// Quizler
model Quiz {
  id        String   @id @default(uuid())
  title     String
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  timeLimit Int?     // Dakika cinsinden süre limiti
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  questions Question[]
  results   QuizResult[]

  @@map("quizzes")
}

// Sorular
model Question {
  id        String   @id @default(uuid())
  text      String   @db.Text
  quizId    String
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  order     Int
  points    Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  answers Answer[]

  @@map("questions")
}

// Cevaplar
model Answer {
  id         String   @id @default(uuid())
  text       String
  isCorrect  Boolean  @default(false)
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("answers")
}

// Quiz Sonuçları
model QuizResult {
  id          String   @id @default(uuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  score       Int
  totalPoints Int
  completedAt DateTime @default(now())

  @@map("quiz_results")
}

// Sertifikalar
model Certificate {
  id             String   @id @default(uuid())
  studentId      String
  student        Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  courseId       String
  course         Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  certificateUrl String?
  issuedAt       DateTime @default(now())

  @@unique([studentId, courseId])
  @@map("certificates")
}
